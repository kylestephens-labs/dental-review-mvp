name: Post-Deploy Smoke Tests

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL for smoke tests'
        required: true
        default: 'https://dental-review-mvp.vercel.app'
        type: string

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # Only run if the deployment workflow succeeded
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      
    - name: Set target URL
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "SMOKE_TEST_URL=${{ github.event.inputs.target_url }}" >> $GITHUB_ENV
        else
          # Default to Vercel deployment URL
          echo "SMOKE_TEST_URL=https://dental-review-mvp.vercel.app" >> $GITHUB_ENV
        fi
        
        echo "ğŸ¯ Target URL: $SMOKE_TEST_URL"
      
    - name: Wait for deployment to be ready
      run: |
        echo "â³ Waiting for deployment to be ready..."
        max_attempts=30
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "Attempt $attempt/$max_attempts: Checking if deployment is ready..."
          
          if curl -f -s "$SMOKE_TEST_URL/healthz" > /dev/null 2>&1; then
            echo "âœ… Health check passed - deployment is ready"
            break
          elif curl -f -s "$SMOKE_TEST_URL" > /dev/null 2>&1; then
            echo "âœ… Main page accessible - deployment is ready"
            break
          else
            echo "â³ Deployment not ready yet, waiting 10 seconds..."
            sleep 10
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ Deployment not ready after $max_attempts attempts"
          exit 1
        fi
      
    - name: Run smoke tests
      run: |
        echo "ğŸ§ª Running smoke tests against $SMOKE_TEST_URL"
        npx playwright test --config=playwright.smoke.config.ts
      
    - name: Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: |
          test-results/
        retention-days: 7
        
    - name: Smoke Test Summary
      if: always()
      run: |
        echo "ğŸ“Š Smoke Test Summary"
        echo "==================="
        echo "Target URL: $SMOKE_TEST_URL"
        echo "Test Results: test-results/smoke-results.json"
        echo "HTML Report: test-results/smoke-report/index.html"
        
        if [ -f "test-results/smoke-results.json" ]; then
          echo "âœ… Test results generated"
        else
          echo "âŒ No test results found"
        fi
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "ğŸš¨ Smoke tests failed!"
        echo "ğŸ”— Check the workflow logs for details"
        echo "ğŸ“Š Test results are available in the artifacts"
        echo "âš ï¸  Deployment may have issues that need immediate attention"
