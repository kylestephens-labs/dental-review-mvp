name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Fast Quality Gate (2-3 minutes max for trunk-based development)
  quality-gate:
    name: Fast Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Type Check
      run: npm run typecheck
      
    - name: Lint
      run: npm run lint
      
    - name: Unit Tests
      run: npm run test
      
    - name: Build Check
      run: npm run build
      
    - name: Quality Gate Summary
      run: |
        echo "✅ Fast Quality Gate PASSED"
        echo "📊 Checks completed:"
        echo "  - Type Check: ✅"
        echo "  - Lint: ✅" 
        echo "  - Unit Tests: ✅"
        echo "  - Build: ✅"
        echo "🚀 Ready for trunk-based development"

  # Deploy to Vercel (only on main branch)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
        
    - name: Deployment Success
      run: |
        echo "🚀 Deployment to production successful!"
        echo "🌐 Application is live and ready for users"
